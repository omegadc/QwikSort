## Overview

The `sorting_job` module provides the top-level functions for orchestrating the entire file sorting process. It takes the defined rulesets and the target folder structure, iterates through all relevant files, applies the rules, logs the actions, and records the necessary information for potential rollback operations.

## Functions

### `create_log_file(log_dir="logs")`

-   **Purpose:** Creates and opens a new log file in a specified directory, named with the current timestamp.
-   **Parameters:**
    -   `log_dir` (str): The relative path to the directory where log files should be stored (defaults to "logs").
-   **Returns:** An open file object in append mode (`"a"`) ready for writing log entries.
-   **Details:** Constructs the log path relative to the location of `sorting_job.py`. Creates the log directory if it doesn't exist. The caller is responsible for closing the returned file object.

### `get_all_files(folder)`

-   **Purpose:** Traverses a `FolderInfo` structure recursively and yields all `FileInfo` objects contained within it and its subfolders.
-   **Parameters:**
    -   `folder` (FolderInfo): The root `FolderInfo` object to start traversal from.
-   **Returns:** A generator yielding `FileInfo` objects.
-   **Details:** Uses recursion (`yield from`) to flatten the potentially nested structure of `FolderInfo` objects into a stream of files.

### `run_sorting_job(rulesets, target_folder, log_dir="logs", description="Sorting Job")`

-   **Purpose:** Executes the main sorting logic across an entire target directory based on a collection of rulesets.
-   **Parameters:**
    -   `rulesets` (dict): A dictionary where keys should be direct folder paths and values are `Ruleset` objects. The current implementation iterates through the values (rulesets) for each file.
    -   `target_folder` (FolderInfo): The `FolderInfo` object representing the root directory (and its scanned contents) where sorting should occur.
    -   `log_dir` (str): The directory for storing log files (passed to `create_log_file`).
    -   `description` (str): A description string for this sorting job batch, used when recording the operation for undo purposes.
-   **Details:**
    1.  Validates that `target_folder` is a `FolderInfo` instance.
    2.  Calls `create_log_file` to open a log file.
    3.  Calls `get_all_files` to get an iterator over all files in the `target_folder` structure and converts it to a list.
    4.  Initializes an empty list `all_records` to store `ActionRecord` objects generated by rule executions.
    5.  Iterates through each `file` in the `all_files` list.
    6.  For each `file`, iterates through all `ruleset` objects provided in the `rulesets` dictionary values.
    7.  Calls `ruleset.run_rules(file, logger=log_file)` for each ruleset. This attempts to apply the ruleset's logic to the file.
    8.  Extends `all_records` with the `ActionRecord`s returned by `run_rules`.
    9.  If `run_rules` returns any records (meaning an action was performed), the inner loop breaks, moving to the next file (assuming a file should only be acted upon by the first matching ruleset it encounters).
    10. Uses a `finally` block to ensure the `log_file` is closed, even if errors occur.
    11. If any `ActionRecord`s were collected (`all_records` is not empty), calls `Backend.rollback.record_batch` to save the performed actions and their reverses for potential undo, using the provided `description`.
-   **Raises:** `ValueError` if `target_folder` is not a `FolderInfo` instance.